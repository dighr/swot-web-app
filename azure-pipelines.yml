# Get code from repo, build images, push images to container registry

trigger:
    - master

resources:
    - repo: self

variables:
    # Container registry service connection established during pipeline creation
    dockerRegistryServiceConnection: "27782c56-68dc-4114-8867-9d2b63d635af"
    imageRepository: "asdf"
    containerRegistry: "swotregistry.azurecr.io"
    dockerfilePath: "$(Build.SourcesDirectory)/docker/frontend/Dockerfile"
    tag: "$(Build.BuildId)"

    # Agent VM image name
    vmImageName: "ubuntu-latest"

stages:
    - stage: Build
      displayName: Build and push stage
      jobs:
          - job: Build
            displayName: Build
            pool:
                vmImage: $(vmImageName)
            steps:
                - task: DownloadSecureFile@1
                  name: nginxEnv
                  displayName: Download Frontend Settings
                  inputs:
                      secureFile: "nginx.env"

                - task: DownloadSecureFile@1
                  name: backendEnv
                  displayName: Download Backend Settings
                  inputs:
                      secureFile: "backend.env"

                - script: |
                      cp $(Build.SourcesDirectory)/docker-compose.yml $(Build.ArtifactStagingDirectory)
                      cp -f $(nginxEnv.secureFilePath) $(Build.SourcesDirectory)/client/.env
                      cp -f $(backendEnv.secureFilePath) $(Build.SourcesDirectory)/.env
                  displayName: Copy Settings

                - task: DockerCompose@0
                  displayName: Build Images
                  inputs:
                      containerregistrytype: "Azure Container Registry"
                      azureSubscription: "Free Trial(1b9406a2-c83f-4aa8-b634-b4f2e5ecc603)"
                      azureContainerRegistry: '{"loginServer":"swotregistry.azurecr.io", "id" : "/subscriptions/1b9406a2-c83f-4aa8-b634-b4f2e5ecc603/resourceGroups/alpha/providers/Microsoft.ContainerRegistry/registries/swotregistry"}'
                      dockerComposeFile: "**/docker-compose.yml"
                      action: "Build services"

                - task: DockerCompose@0
                  displayName: Push Images
                  inputs:
                      containerregistrytype: "Azure Container Registry"
                      azureSubscription: "Free Trial(1b9406a2-c83f-4aa8-b634-b4f2e5ecc603)"
                      azureContainerRegistry: '{"loginServer":"swotregistry.azurecr.io", "id" : "/subscriptions/1b9406a2-c83f-4aa8-b634-b4f2e5ecc603/resourceGroups/alpha/providers/Microsoft.ContainerRegistry/registries/swotregistry"}'
                      dockerComposeFile: "**/docker-compose.yml"
                      action: "Push services"

                - task: PublishPipelineArtifact@1
                  displayName: Publish Artifacts
                  inputs:
                      targetPath: "$(Build.ArtifactStagingDirectory)"
                      publishLocation: "pipeline"
                      artifact: $(Build.BuildId)
